class: titlepage
background-size: contain
background-image: url(template/bg-face.svg)

# Переосмысление Picodata <br/>в качестве cluster-first СУБД
## Ярослав Дынников
### Picodata
.footnote[Слайды: https://rosik.github.io/2024-shl]
???
- Привет меня зовут Ярослав Дынников
- Я разрабатываю распределенную СУБД Picodata
- И собираюсь сегодня познакомить с ней _вас_

<!-- ############################################################ -->
---
# План доклада
1. Питч
1. Архитектура и алгоритмы
1. Конкурентные отличия
1. Расширение функциональности
???
- План доклада такой
- Я сначала запитчу наш продукт
- Потом обрисую на верхнем уровне архитектуру
- Расскажу про применяемые алгоритмы
- И из этого мы сможем сделать выводы о конкурентных отличиях пикодаты
  от других вендоров
- А если этого вам покажется мало, в заключение я расскажу как мы
  планируем _дополнительно_ расширять функциональность при помощи плагинов
  на Rust
- Ну а пока поехали

<!-- ############################################################ -->
---
# Picodata — это
- Distributed SQL
???
- С точки зрения пользователя мы — достаточно обычная база данных
- У нас есть SQL — `select * from`, `join`, и вот это все
- SQL, естесвенно, распределенный, мы с вами на хайлоаде все-таки
- Пользователь взаимодействует с кластером как с единым ресурсом,
  а под капотом спрятано
---
# Picodata — это
- Distributed SQL
- Sharding, replication
???
- _шардирование_ и _репликация_
- Отличительных особенностей у нас две

---
# Picodata — это
- Distributed SQL
- Sharding, replication
- In-memory
???
- Первая заключается в том, что все данные лежат в _оперативной памяти_
- Этим мы режем косты по латенси за счет экономии на доступе к диску
- Это не значит что мы им не пользуемся, нет
- write ahead log пишетя на жесткий диск,
- Но чтение всегда выполняется из оперативной памяти

---
# Picodata — это
- Distributed SQL
- Sharding, replication
- In-memory, single-threaded
???
- Вторая особенность состоит в том, что
- Доступ к локальному хранилищу реализован однопоточным, а потому без
  блокировок
- И это снова идет на руку производительности

---
# Picodata — это
- Distributed SQL
- Sharding, replication
- In-memory, single-threaded
- Горизонтальное масштабирование
???
- Масштабируемся мы исключительно горизонтальным образом
- И даже если речь идет о современных многоядерных системах,
- то утилизация ресурсов достигается за счет развертывания нескольких
  инстансов субд, а не за счет многопоточности

---
# Picodata — это
- Distributed SQL
- Sharding, replication
- In-memory, single-threaded
- Горизонтальное масштабирование
- ...
???
- Итак, распределенный SQL, оперативная память, низкий латенси
- Что получится если все это сложить вместе?

<!-- ############################################################ -->
---
<br><br><br><br><br>
.center[
![:scale 360px](images/logo-picodata-full.svg)
<!-- # Picodata — -->
<p>Маленькие, быстрые данные</p>
]
???
- Пикодата. Маленькие, быстрые данные

<!-- ############################################################ -->
---
class: sectionpage
count: false
background-size: contain
background-image: url(template/bg-section.svg)
# Катакомбы Picodata
## Обзорная экскурсия
???
- Ну а я пришел сегодня выступить в роли _экскурсовода_
- Хочу вас познакомить с продуктом изнутри, со стороны разработки

<!-- ############################################################ -->
---
# Что было до
???
- И начать я хочу с _исторической справки_
- Надо понимать, что такие сложные продукты, как распределенная субд, в
  вакууме не создаются
- И вообще исторические причины зачастую играют _решающую_ роль в вопросах
  выбора архитектуры
- Почему тот или иной код написан так а не иначе? _Исторически сложилось_
- И вот так исторически сложилось, что

---
# Что было до
## Tarantool
In-memory СУБД и сервер приложений на Lua<br>
Get your data in RAM. Get compute close to data. Enjoy the performance
???
- Я и мои коллеги в прошлом тесно связаны c тарантулом
- Tarantool — это БД и аппсервер в одном флаконе
- Идея в следующем
- Держите данные в оперативной памяти
- Проводите вычисления рядом с данными
- Наслаждайтесь скоростью
- Так гласит лозунг тарантула

---
# Что было до
## Tarantool
In-memory СУБД и сервер приложений на Lua<br>
Get your data in RAM. Get compute close to data. Enjoy the performance
## Vshard
Модуль шардирования на основе виртуальных бакетов
???
- Благодаря своему определению про аппсервер тарантул оброс богатой
  экосистемой
- И следующая технология которую я упомяну — это модуль Vshard
- Тарантул сам по себе умеет релицироваться
- А шардирование реализовано в виде отдельной библиотеки

---
# Что было до
## Tarantool
In-memory СУБД и сервер приложений на Lua<br>
Get your data in RAM. Get compute close to data. Enjoy the performance
## Vshard
Модуль шардирования на основе виртуальных бакетов
## Cartridge
Фреймворк для разработки распределенных приложений
???
- Чтобы всем эим урпавлять был картридж
- Изначальо он создавался как инструмент для управления кластером вшарда
- но со временем разросся в целый фреймворк
- Он закрывал вопросы связанные с разработкой и тестированием приложений,
- Ну и для эксплуатации служил
- Вот такая богатая экосистема

<!-- ############################################################ -->
---
# Особенности экосистемы
## Performance
Быстро, но не всегда предсказуемо (LuaJIT, GC)
???
- Но у нее были особенности, которые никак не удавалось решить
- Во-первых к быстродействию были вопросики
- Сервер приложений на луа это не что иное как интерпретатор LuaJIT
- с just in time компиляцией
- и с GC stop the world
- Обычно все идет хорошо, но если нет, то удачи с отладкой

---
# Особенности экосистемы
## Performance
Быстро, но не всегда предсказуемо (LuaJIT, GC)
## Функциональные
SQL есть, но в рамках одного узла
???
- Во-вторых огорчает чисто функциональное ограничение
- SQL есть, но только локальный
- А шардирование уровнем выше
- Получается SQL ничего не знает что данные разделены
- Это странно

---
# Особенности экосистемы
## Performance
Быстро, но не всегда предсказуемо (LuaJIT, GC)
## Функциональные
SQL есть, но в рамках одного узла
## Разработка
Очень интересно, но сложно
???
- Разработка была очень увлекательной, но сложной
- Вся экосистема вокруг тарантула достаточно специфичной
- Это во-первых _обучение_ делает более трудоемким
- Да и в принципе разработка распределенных приложений — наука не из простых
- В качестве иллюстрации приведу такой пример из кода, который достался
  мне на ревью.
- Функция локально открывает транзакцию, потом делает
  несколько вызовов по сети на другие узлы, потом коммитит локально
  транзакцию.
- Ах если бы распределенные транзакции работали так просто

---
# Особенности экосистемы
## Performance
Быстро, но не всегда предсказуемо (LuaJIT, GC)
## Функциональные
SQL есть, но в рамках одного узла
## Разработка
Очень интересно, но сложно
## Эксплуатация
То слишком гибко, то слишком жестко (two-phase commit)
???

- Ну и вернемся к тарантулу и его экосистеме, про эксплуатацию
- С одной картридж позволял управлять каждым репликасетом в отдельности
- А типичный кластер ­это 100 роутеров и 200 стораджей с репликацией
- И управлять каждым в отдельности ну никак не хочется
- Поэтому картриджем управлял ансибл, а конфиги для ансибла генерировал
  питоновский скрипт
- А хуже всего то, что картридж не использовл кворумный подход, а
  требовал консистентности конфигурации на всех инстансах до одного
- Для распространения конфигурации использовался двухфазный коммит, и
- Из-за одного тупящего инстанса страдал кластер в целом

<!-- ############################################################ -->
---
# План
1. Заменить two-phase commit на Raft
1. Реализовать распределенный SQL
2. И все это на Rust
3. ???
4. Profit
???
- Итак, план был такой
- ...
- Попутно переписать все это на Rust чтобы нас GC не донимал
- Забегая вперед сразу скажу что у нас все получилось
- А теперь же перейдем к архитектуре и алгоритмам

<!-- ############################################################ -->
---
class: sectionpage
count: false
background-size: contain
background-image: url(template/bg-section.svg)
# Архитектура
## и алгоритмы

<!-- ############################################################ -->
---
# Raft
Алгоритм для решения задач консенсуса<br>
в сети ненадежных вычислений<br><br>
.center[![:scale 1050px](images/raft-1.svg#frame2)]
???
- Raft - это ... Так нам википедия говорит
- А я попробую объяснить что это значит на пальцах
- Стопка желтых прямоугольников на картинке - это узлы в кластере
- Их много и все одинаковые
- Они хотят согласованно хранить некоторое состояние (state machine)
- Чтобы этого добиться raft предлагает сохранить все _изменения_
  состояния в некоторый журнал.
- Что именно должно лежать в журнале рафт не навязывает,
- Raft определяет правила, по которым этот журнал дожен реплицироваться
- Таким образом имея одинаковый журнал мы можем быть уверены что и
  состояние отличаться не будет

---
# Raft
Алгоритм для решения задач консенсуса<br>
в сети ненадежных вычислений<br><br>
.center[![:scale 1050px](images/raft-1.svg#frame1)]
???
- Если посмотреть как это ложится на нашу экосистему получится
- Состояние - это совокупность данных, которые хранит инстанс
- Журнал хранится в тарантуле, но это не wal
- Raft-журнал это отдельный спейс
- Аналогия с фс

<!-- ############################################################ -->
---
# Cluster manager
.center[![:scale 1050px](images/cluster-manager.svg#frame4)]

---
# Cluster manager
.center[![:scale 1050px](images/cluster-manager.svg#frame1)]

---
# Cluster manager
.center[![:scale 1050px](images/cluster-manager.svg#frame2)]

---
# Cluster manager
.center[![:scale 1050px](images/cluster-manager.svg#frame3)]

<!-- ############################################################ -->
---
# Иерархия
.center[![:scale 1050px](images/pyramid.svg)]

<!-- ############################################################ -->
---
# Описание структуры
<style type="text/css">
.tg  {border-collapse:collapse;border-spacing:0;float:left;margin-right:60px}
.tg td{border-color:black;border-style:solid;border-width:1px;font-size:20pt;
  overflow:hidden;padding:10px 5px;word-break:normal;}
.tg th{border-color:black;border-style:solid;border-width:1px;font-size:20pt;
  font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal;}
.tg .tg-c{border-color:inherit;text-align:center;vertical-align:top}
.tg .tg-l{border-color:inherit;text-align:left;vertical-align:top}
.tg .tg-lb{font-weight:bold;text-align:left;vertical-align:top}
</style>

<table class="tg">
  <thead>
  <tr> <th class="tg-c" colspan="2">INSTANCE</th> </tr>
  </thead>
<tbody>
  <tr> <td></td>                <td class="tg-l">raft_id</td></tr>
  <tr> <td class="tg-l">PK</td> <td class="tg-l">instance_id</td> </tr>
  <tr> <td class="tg-l">FK</td> <td class="tg-l">replicaset_id</td> </tr>
  <tr> <td></td>                <td class="tg-lb">current_state</td> </tr>
  <tr> <td></td>                <td class="tg-lb">target_state</td> </tr>
</tbody>
</table>
.footnote[
Важно: не status, а state!<br>
State: Online ⇆ Offline; `generation`<br>
]

--
<table class="tg" style="">
  <thead>
  <tr> <th class="tg-c" colspan="2">REPLICASET</th> </tr>
  </thead>
<tbody>
  <tr> <td class="tg-l">PK</td> <td class="tg-l">replicaset_id</td> </tr>
  <tr> <td class="tg-l">FK</td> <td class="tg-l">tier</td> </tr>
  <tr> <td></td>                <td class="tg-lb">current_master</td> </tr>
  <tr> <td></td>                <td class="tg-lb">target_master</td> </tr>
</tbody>
</table>
--
<table class="tg" style="">
  <thead>
  <tr> <th class="tg-c" colspan="2">TIER</th> </tr>
  </thead>
<tbody>
  <tr> <td class="tg-l">PK</td> <td class="tg-l">tier</td> </tr>
  <tr> <td></td>                <td class="tg-l">replication_factor</td> </tr>
  <tr> <td></td>                <td class="tg-l">can_vote</td> </tr>
</tbody>
</table>

<!-- ############################################################ -->
---
# Лидер, фолловер, кандидат
.center[![:scale 1050px](images/raft-states.svg)]
*Leader* единственный пишет в журнал + пингует окружающих<br>
???
- Raft - централизованный протокол
--
*Follower* пассивен, не отправляет никаких запросов<br>
--
*Candidate* проводит голосование<br>

<!-- ############################################################ -->
---
# Кластер из N инстансов
--
- часть из них *can_vote*
--
- 5 из них *voters*, все остальные *learners*
--
- 1 из них *Leader*, все остальные *Follower*

<!-- ############################################################ -->
---
# Хранение данных
--
- Таблицы бывают *шардированные* и *глобальные*
--
- Схема данных единая на весь кластер
--
- Доступ к данным посредством языка SQL

<!-- ############################################################ -->
---
# Распределенный SQL
<div style="float:left;width:30%;line-height:1.3"><p>
INNER JOIN<br>
LEFT OUTER JOIN<br>
WHERE<br>
WHERE ... IN<br>
GROUP BY<br>
HAVING<br>
ORDER BY<br>
UNION ALL<br>
DISTINCT<br>
EXCEPT DISTINCT<br>
</p></div>
<img src="images/ebnf-select.svg" style="width:730px;float:right;">
.footnote[https://docs.picodata.io/picodata/24.4/sql_index/]

<!-- ############################################################ -->
---
# Обработка запроса
```sql
SELECT W_ID, W_NAME FROM WAREHOUSE
```
.center[<img src="images/ast.svg" style="width:600px;">]


<!-- ############################################################ -->
---
# Итого
<p>Историческая справка, Tarantool<p\>
<p>Алгоритм Raft<p\>
<p>Иерархия — инстансы, репликасеты, тиры, кластер<p\>
<p>Не status, а state<p\>
<p>Лидер, фолловер, кандидат<p\>
<p>Динамическое переключение голосующих узлов<p\>
<p>Единая схема данных<p\>
<p>Распределенный SQL<p\>
???
- Ни одной новой идеи, но комбинация уникальна
- Например, точечные запросы по предагрегированным витринам данных
<!-- ############################################################ -->
---
class: finalpage
background-size: contain
background-image: url(template/bg-final.svg)

# Материалы
- Слайды: https://rosik.github.io/2024-shl
- Picodata: https://picodata.io/
- Telegram: [@picodataru](https://t.me/picodataru)

.qr[
  **Обратная связь**:<br/><br/>
  ![:scale 100%](images/qr.gif)
  <a href="https://conf.ontico.ru/online/shl2024/lectures/5409989/to-card">
  https://conf.ontico.ru<br>
  /online/shl2024<br>
  /details/5492379
  </a><br/><br/>
]
???
- Голосование
- Вопросы
- Награждение

<!-- - 24 активных контрибутора в репе, 1 внешний -->
<!-- - Initial commit 22 ноября 2021  -->
<!-- ############################################################ -->
---
# Состояние записей в raft-журнале
.center[![:scale 1050px](images/raft-log-1.svg)]

<!-- ############################################################ -->
---
# Виды операций в raft-журнале
```rust
pub enum Op {
    Nop,
    Dml(Dml),
    DdlPrepare { schema_version: u64, ddl: Ddl },
    DdlCommit,
    DdlAbort,
    Acl(Acl),
}
```
