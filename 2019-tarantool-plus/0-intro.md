class: center
background-size: contain
background-image: url(bg-title.png)

.titlepage[
# Чем полезен Tarantool Enterprise

## Ярослав Дынников
<!-- <br> -->

### .grey[Tarantool, Mail<span>.</span>Ru Group]
#### .grey[17 июня 2019]
]

<!-- ---
## Тезисы

- ТЕ - коммерческий проект, появился в прошлом году.
- Кластер
- - Нужен, чтобы шардировать было удобно.
- - Вшард - давний, стандартный инструмент шардирования.
- - Вшард управляется программно, lua и таблицы.
- - Кластер добавляет концепции "распределенная конфигурация".
- - Главное в конфиге это топология кластера: репликасеты и инстансы.
- - Как инстанс инициалзирует себя, биндинд порт, ходит по гостям.
- - Протокол SWIM для обещения инстансов и мониторинга здоровья.
- - Изгнание инстансов или временное отключение (WIP)?
- Framework и соглашения.
- - "Роль", какие роли на каком репликасете. Разница с докером.
- - - Пример про "Stateless узлы" с бизнес логикой и "storage" узлы.
- - Рукоятки роли и Lifecycle.
- - Примеры использования ролей (на размноженных слайдах).
- - У кластера есть апи для обновления конфигурации по частям.
- - - HTTP API для работы с конфигурацией.
- - - Роли могут пользоваться конфигурацией при накате конфига.
- - Кластер дает API чтобы одна роль могла вызвать другую
- - - Пример, зачем роли могут вызывать друг друга.
- - Весь код для кластера должен запускаться из одной кодовой базе.

- - рокспека с зависимостями.
- - tarantoolapp pack
- - - Деплоится на сервер одним файлом.
- - - оффлайн репозиторий роксов
- - для деплоя рутовые права не нужны.
- Коннекторы к разным базам - оракл, и др.
- Статически собранный тарантул
- веб морда
- - апи можно дергать также через веб морду
- - В веб-морде кластера есть авторизация
- - space-explorer

 -->

<!--

Я развиваю ТТЕЕ.
Тарантул энтерпрайз - это коммерческий проект, который появился в прошлом году.

Наша команда состоит из двух частей - кора и солюшен.
Кора развивает опенсорсную версию, а солюшены разрабатывают проекты под заказчиков.
Мы накопили много опыта, и обобщили его в энтерпрайзной версии.
Я предположу что все знакомы с опенсорсной версией, и расскажу, чем коммерческая от неё отличается.
Тарантул энтерпрайз объединяет несколько полезных для разработчика штук.

Первая полезная штука в тарантул энтерпрайз - это кластер.

Мы не устаём повторять, что Тарантул - это база данных и аппликейшн сервер в одном флаконе.
Это конечно здорово, но даже для небольших проектов одного флакона часто не хватает.
Встаёт вопрос. Как заставить несколько тарантулов работать сообща.
Ответ на этот вопрос - кластер.

В основе кластера лежит другой модуль - вшард.
Это опенсорсный модуль, не энтерпрайз.
И здесь мне придётся немного отклониться от темы и рассказать немного про сам вшард.
Вшард позволяет сделать базу данных распределённой.

Вшард управляется программно при помощи луашных таблиц.
Вот представьте, у нас есть два шарда. половина данных на одном сторадже, половина на другом.
И рядом стоит роутер, который знает, где что лежит.
И представьте, вам нужно добавить пару стораджей.
Для этого нужно подредактировать конфигурационные файлы, стартануть новые инстансы,
и потом обновить конфиг на всех старых.
Желательно делать это на лету, без перезапуска, чтобы не было даунтайма.
Конфиги на всех инстансах были одинаковыми, иначе вся распределённая систма будет работать с сюрпризами.

Понятно, что никто не захочет заниматься этим вручную, поэтому в ход идут скрипты.
И здесь нам на помощь приходит кластер.
Кластер управляет конфигурацией вшарда сам.
Для этого в кластере вводится понятие "распределённая конфигурация".
По сути это простой ямль файлик, копия которого хранится на каждом инстансе.

Давайте посмотрим на конфигурацию подробнее.
Самое главное в конфиге - это топология.
Кластер состоит из инстансов. Один инстанс - это один запущенный процесс тарантула.
Инстансы сгруппированы по репликасетам.
Все инстансы в одном репликасете реплицируют данные между собой.

В каждом репликасете есть один инстанс лидер.
Обычно это тот инстанс, на который идёт запись.

Кластер внимательно следит, чтобы на всех инстансах конфиг был одинаковым.
Мы очень не хотим, чтобы инстансы потерялись.
Конфиг обновляется дфухфазным коммитом на всех инстансах сразу,
так что если один из инстансов ушёл оффлайн, то конфиг попросту не применится и конфиг не разъедется.

Как раз на этот случай кластер умеет следить за здоровьем инстансов.
Для мониторинга используется протокол SWIM,
о котором сегодня утром рассказывал Влад Шпилевой.
Инстансы периодически пингуют друг друга,
и в случае проблем начинают распространять слухи о том, что один из них приболел.

При необходимости тот инстанс который остался в живых может взять лидерство на себя.

Пора перейти к следующей большой теме -
как кластер помогает разрабатывать приложения.
Мы уже поговорили про вшард и распределённую конфигурацию.
Теперь надо придумать, куда впихнуть бизнес логику.

Мы когда обсуждали проекты и архитектуру в какой-то момент заметили,
что очань часто обсуждение скатывается до обсуждения работы сервисов.
Давайте я приведу конкретный пример чтобы всем было проще.
Нам приходят данные. Мы их обрабатывам и сохраняем в базу, а раз в сутки строим отчет.
Вот и получается - нам нужен компонент, который обрабатывает данные,
хранением займётся вшард, и ещё один компонент должен выполнять задачи по расписанию.

Так родилась концепция "ролей". Роль - это луашный модуль, консолидирующий кусочек логики.
Вшард-роутер и вшард сторадж это тоже роли.
Информация о том, где какая роль должна быть включена, хранится в распределённом конфиге.
В этом примере у меня получилось три инстанса. В проде наверняка будет больше шардов, плюс репликация.

Но что, если это всё излишне? Что, если мы хотим продемонстрировать функциональность или прогнать тесты?
Тоже ничего страшного, все роли можно проинициализировать на одном инстансе, и вообще
у вас кластер будет из одной ноды состоять.

Давайте тепрь поговорим про жизненный цикл роли.
Управление ролью происходит при помощи четырёх колбеков. Кластер дёргает их сам.

Когда роль включается - кластер дёргает функцию инит.
Роль препроцессора может инициализировать своё личное хттп апи.
Роль стораджа создаст спейсы и зарегает хранимки.

Роли могут пользоваться информацией из распределённой конфигурации. Так тоже можно.
Например, наш абстракный шедулер может хранить там свой расписание.
За применение конфигурации отвечают функции validate_config и apply_config.
Они вызываются каждый раз, когда изменяется конфигурация.
Добавили инстанс - считается. Поменяли список ролей - apply config.

Ну и четвертый пункт на случай если роль при выключении хочет подчистить за собой
результаты жизнедеятельности - функция стоп.
Тот же шедулер из примера может останавливать таймеры или что он там использует.

Ладно, с жизненным циклом разобрались.
Что ещё полезного можно делать с ролями?
У ролей есть RPC. Это нужно чтобы роли могли взаимодействовать.
Он работает через старый добрый нетбокс, зато упрощает поиск необходимого инстанса.
Например та же апишная роль из примера может дёргать шедулер напрямую.

Чем-то это напоминает микросервисы и контейнеры в докере, но есть ряд отличий.
Во-первых, мы не деплоим роли по-отдельности. Все роли являются частю одного проекта,
и даже выключенные роли присутствуют на всех инстансах.
Во-вторых, на одном инстансе тарантула роль либо включена, либо выключена.
Мы не можем поступить как с докером, сказать "эй докер, задеплой мне 10 копий шедулера где-нибудь".

В-третьих, я вот всё говорю про отдельные инстансы, но если речь зайдёт о репликасетах, то
роль должна включаться на всех инстансах в репликасете.
Ну потому что невозможно себе представить что у двух близняшек в одном репликасете были бы разные роли.



Про кластер и роли я рассказал, но до гипотетического прода ещё остаётся несколько шагов.
Итак, мы проговорили архитектуру гипотетического приложения с двумя ролями,
теперь посмотрим как воплотить её в жизнь и донести до прода.
В ТЕ имеется такая утилита тарантулапп - она помогает работать с проектами.

Первая её функция - это бутстрап проекта.
Вы запускаете tarantoolapp create и получаете готовый гит репозиторий с черновиком проекта.
Там есть наброски роли, инит скрипт, рокспека в которую можно вписать зависимости, и еще немного всякого по мелочи.

Второй раз тарантул апп пригодится когда дело дойдёт для деплоя.
Как я уже сказал, весь кластер должен деплоиться из одной кодовой базы.
Тарантулапп поможет упаковать весь проект в один артефакт, который можно отгрузить на сервер и запустить.

В архив попадут все файлы проекта, все зависимости, ну и конечно сам тарантул.
Примечательно то, что в энтерпрайзной версии тарантул собран статически,
так на сервере вообще не нужно заботиться о зависимостях и окружении.
Просто копируете рпмку, устанавливаете и запускаете при помощи системд. Системдшные юниты также генерируются при упаковке рпм.
Для установки рпм потребуются рутовые права на сервере, а с ним как показывает опыт бывают проблемы.
Но даже если рутовых прав нет, тарантулапп может запаковать таргз архив, и уж с ним точно никаких проблем не возникнет.

Ну вот, на этом почти всё.
Мне осталось упомянуть, что в энтерпрайзной версии есть коннекторы к разным другим базам.

 -->