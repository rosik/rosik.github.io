<!-- ############################################################ -->
## Lua –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ–π

```lua
local function hello(name)
    print('Hello, ' .. name .. '!')
end

local names = {'World', 'Highload', 'Moscow'}

for i, name in pairs(name) do
    hello(name)
end
```

```console
Hello, World!
Hello, Moscow!
Hello, Highload!
```

???

–ù–∞—á–Ω—É –∏–∑–¥–∞–ª–µ–∫–∞, –≤–¥—Ä—É–≥ –∫—Ç–æ-—Ç–æ –≤ –ø–µ—Ä–≤—ã–π —Ä–∞–∑ –∫ –Ω–∞–º –≤ –≥–æ—Å—Ç–∏ –∑–∞—à—ë–ª.
–ß—Ç–æ —Ç–∞–∫–æ–µ –õ—É–∞ –∏ —á—Ç–æ –≤ –Ω—ë–º –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ–≥–æ?
–ü—Ä–æ—Å—Ç–æ–π, –ª–µ–≥–∫–æ –∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å –≤ –≥–æ–ª–æ–≤–µ

<!-- ############################################################ -->
---

## –¢–∏–ø–∏–∑–∞—Ü–∏—è

- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è

- –ù–µ —Å–∏–ª—å–Ω–∞—è (–Ω–æ –ø–æ—á—Ç–∏)

???

–õ—É–∞ –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –∫ —è–∑—ã–∫–∞–º —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π, –∏ —ç—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç –∂–∏–∑–Ω—å
–∏ —É—Å–∫–æ—Ä—è–µ—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É. –ö—Ç–æ –ø—Ä–æ–±–æ–≤–∞–ª –Ω–∞ –ø–ª—é—Å–∞—Ö –ø–∞—Ä—Å–∏—Ç—å –∂—Å–æ–Ω, —Ç–æ—Ç –∑–Ω–∞–µ—Ç.
<br/><br/>
–ö –≤–æ–ø—Ä–æ—Å–æ–º —Å–∏–ª—å–Ω–æ–π / —Å–ª–∞–±–æ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–∏ –º—ã –ø—Ä–∏–¥—ë–º –ø–æ–∑–∂–µ, –∞ –ø–æ–∫–∞ –ø—Ä–∏–º–µ—Ä
–∏–∑ –∂–∏–∑–Ω–∏.

<!-- ############################################################ -->
---

## –ü—Ä–∏–º–µ—Ä –∏–∑ –∂–∏–∑–Ω–∏


```lua
for uuid, new_leader in pairs(new_leaders) do
    log.info('Replicaset %s: new leader %s, was %s',
        uuid,
        describe(new_leader),
        describe(old_leaders[uuid])
    )
end
```

???

- –ù–∞–º –Ω–∞–¥–æ –±—ã–ª–æ —É–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## –ü—Ä–∏–º–µ—Ä –∏–∑ –∂–∏–∑–Ω–∏

```diff
for uuid, new_leader in pairs(new_leaders) do
+   if uuid == my_uuid then
+       uuid = uuid .. ' (me)'
+   end

    log.info('Replicaset %s: new leader %s, was %s',
        uuid,
        describe(new_leader),
        describe(old_leaders[uuid])
    )
end
```

???

- –Ø —Ä–µ—à–∏–ª —á—Ç–æ —ç—Ç–æ–≥–æ –º–∞–ª–æ

---

## –ü—Ä–∏–º–µ—Ä –∏–∑ –∂–∏–∑–Ω–∏

```diff
for uuid, new_leader in pairs(new_leaders) do
+   if uuid == my_uuid then
+       uuid = uuid .. ' (me)'
+   end

    log.info('Replicaset %s: new leader %s, was %s',
        uuid,
        describe(new_leader),
*       describe(old_leaders[uuid]) -- nil (–∏–Ω–æ–≥–¥–∞)
    )
end
```

???

- –ë–∞–±–∞—Ö

---

## –ü—Ä–∏–º–µ—Ä –∏–∑ –∂–∏–∑–Ω–∏

```diff
for uuid, new_leader in pairs(new_leaders) do
+   local replicaset_name = uuid

    if uuid == my_uuid then
-       uuid = uuid .. ' (me)'
+       replicaset_name = replicaset_name .. ' (me)'
    end

    log.info('Replicaset %s: new leader %s, was %s',
-       uuid,
+       replicaset_name,
        describe(new_leader),
        describe(old_leaders[uuid])
    )
end
```

???

- –ù–∞–¥–æ –±—ã–ª–æ —Ç–∞–∫
- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è –Ω–µ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –≤ –∫–æ–¥–µ –º–æ–∂–Ω–æ
  –∑–∞–≤–µ—Å—Ç–∏ 3 –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ abc –∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Ö –ø–æ
  –∫—Ä—É–≥—É —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏

<!-- ############################################################ -->
---

## –¢–∏–ø–∏–∑–∞—Ü–∏—è ‚Äî –Ω–µ —Å–∏–ª—å–Ω–∞—è

–ù–µ–ª—å–∑—è

```lua
"k" .. nil -- attempt to concatenate a nil value
{1, 2} + {3} -- attempt to perform arithmetic on a table value
-- Python: [1, 2] + [3] == [1, 2, 3]
-- JS:     [1, 2] + [3] == '1,23'
```

???

- –°–ª–∞–±–æ–π –µ—ë –Ω–∞–∑–≤–∞—Ç—å —è–∑—ã–∫ –Ω–µ –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è
- –≠—Ç–æ –∫–ª–∞—Å—Å–Ω–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ Lua –ª–µ–≥–∫–æ –∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞—Ç—å –≤ –≥–æ–ª–æ–≤–µ

--

–ú–æ–∂–Ω–æ


```lua
math.sqrt("144") -- 12 (number)

string.len(1337) -- 4
```

.footnote[
  Lua 5.1 Reference Manual.
  [¬ß2.2.1 Coercion](https://www.lua.org/manual/5.1/manual.html#2.2.1)
]

???

- –ù—É–∂–Ω–æ: —è–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å tostring, tonumber
- –ù—É–∂–Ω–æ: –ø—Ä–æ–≤–µ—Ä—è—Ç—å —Ç–∏–ø—ã –≤—Ö–æ–¥–Ω—ã—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤

<!-- # CHECKS ################################################### -->
---

## –ê—Ä–≥—É–º–µ–Ω—Ç—ã –Ω–∞–¥–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å

```lua
function get_stat(uri, opts)
    return http.get('http://' .. uri .. '/stat', opts)
end
```

--

```lua
get_stat(req.uri) -- req.uri == nil
-- error: api.lua:310: attempt to concatenate a nil value
-- –ù–µ –ø–æ–Ω—è—Ç–Ω–æ
```

---

## –ê—Ä–≥—É–º–µ–Ω—Ç—ã –Ω–∞–¥–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å

```lua
function get_stat(uri, opts)
    assert(type(uri) == 'string', 'uri must be a string')
    -- ...
end
```

--

```lua
get_stat(req.uri) -- req.uri == nil
-- error: api.lua:310: uri must be a string
-- –£–∂–µ –ª—É—á—à–µ
```

--

```lua
get_stat('localhost', {timeuot = 1})
--                         ^^ typo
-- –û—à–∏–±–∫–∏ –Ω–µ—Ç, –Ω–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ
```

---

## –ê—Ä–≥—É–º–µ–Ω—Ç—ã –Ω–∞–¥–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å

```lua
require('checks')

function get_stat(uri, opts)
    checks('string', {timeout = '?number'})
    -- ...
end
```

--

```lua
get_stat()
-- error: bad argument #1 to get_stat (string expected, got nil)
```

--

```lua
get_stat('localhost', {timeuot = 1})
-- error: unexpected argument opts.timeuot to get_stat
```

???

- –ò —Ä–∞–∑ —É–∂ –æ–± —ç—Ç–æ–º –∑–∞—à–ª–∞ —Ä–µ—á—å, —É–ø–æ–º—è–Ω—É –µ—â—ë —á—Ç–æ –≤ –º–∏—Ä–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç —Ç–∞–∫–æ–π
  –∫–ª–∞—Å—Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∫–∞–∫ –ª–∏–Ω—Ç–µ—Ä—ã. –î–ª—è –ª—É–∞ —ç—Ç–æ –ª—É–∞—á–µ–∫. –û–Ω –ø—Ä—è–º –≤
  —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç —Å–∞–º—ã–µ –≤–æ–ø–∏—é—â–∏–µ –æ—à–∏–±–∫–∏.

<!-- ############################################################ -->
---

## –¢–∏–ø–∏–∑–∞—Ü–∏—è ‚Äî –ø—Ä–æ—Å—Ç–∞—è, –∫–∞–∫ —Ç–æ–ø–æ—Ä

- boolean, string, number

- function, thread

- userdata, .grey[cdata]

- table

- nil

???

- cdata - —ç—Ç–æ —Ç–∏–ø –∏–∑ luajit, –≤ –æ–±—ã—á–Ω–æ–º –ª—É–∞ –µ–≥–æ –Ω–µ—Ç.
- cdata –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∏–∑ –ª—É–∞—à–∫–∏ —Å–∏—à–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π —Ç–∏–ø–æ–≤.

<!-- ############################################################ -->
---

## number == double

???

–í –ª—É–∞ 5.1 –∏ 5.2 —ç—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç. –§–ª–∞–≥–∞–º–∏ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä–∞ –º–æ–∂–Ω–æ
–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞ float –∏–ª–∏ long double.

--

```lua
assert_equals(0.1 + 0.2, 0.3)
-- error:
-- expected: 0.3
--   actual: 0.3
```

???

–° –æ–¥–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –Ω–∏–∫–∞–∫–∏—Ö —Å—é—Ä–ø—Ä–∏–∑–æ–≤ —Å –Ω–µ—è–≤–Ω—ã–º–∏ –∫–∞—Å—Ç–∞–º–∏
signed <-> unsigned. –ù–æ —Å—é—Ä–ø—Ä–∏–∑—ã –¥–∞–±–ª–æ–≤ –≤—Å–µ –Ω–∞ –º–µ—Å—Ç–µ.

--

```lua
2^53 - 2 -- 9007199254740990
2^53 - 1 -- 9007199254740991
*2^53 + 0 -- 9007199254740992
*2^53 + 1 -- 9007199254740992
2^53 + 2 -- 9007199254740994

2^53 + 1 == 2^53 -- true
```

???

–ß–∏—Å–ª–∞ –æ—Ç 2^52 –¥–æ 2^53 –ø—Ä–µ–¥—Å—Ç–∞–≤–∏–º—ã —Å —Ç–æ—á–Ω–æ—Å—Ç—å—é –¥–æ 1, –∏—Ç–¥

--

```lua
now = clock.time64() -- 1621068872741010434, ~2^60
ffi.typeof(t) -- ctype<uint64_t>
```

???

–ö–∞–∫ –∫—É—Å–∞–µ—Ç—Å—è? –ï—Å—Ç—å –Ω–∞–ø—Ä–∏–º–µ—Ä –∞–ø–∏—à–∫–∞ clock.time64 - –≤—Ä–µ–º—è –≤
–Ω–∞–Ω–æ—Å–µ–∫—É–Ω–¥–∞—Ö —Å –Ω–∞—á–∞–ª–∞ —ç–ø–æ—Ö–∏. –ò—Å–ø–æ–ª—å–∑—É—é—Ç –∫–∞–∫ —Ç–∞–π–º—Å—Ç–∞–º–ø—ã, –ø–∞—Ä–∞
–Ω–µ–∞–∫–∫—É—Ä–∞—Ç–Ω—ã—Ö —Ç–∞–π–ø–∫–∞—Å—Ç–æ–≤ –∏ –ø—Ä–∏–≤–µ—Ç.
<br/><br/>
–í –ª—É–∞ 5.3 –∑–∞–≤–µ–∑–ª–∏ –µ—â—ë –∏ integer, –Ω–æ —ç—Ç–æ –∫–∞—Å–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ
–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è

<!-- ############################################################ -->
---
## IEEE 754

.center[![:scale 900px](images/double.svg)]
.center[![:scale 600px](images/double-formula.3.svg)]

???

–≠—Ç–æ –∫–∞—Å–∞–µ—Ç—Å—è –Ω–µ —Ç–æ–ª—å–∫–æ –ª—É–∞, —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç I-triple-E

--

.center[
```console
s 11111111111 00..0 ‚ÇÇ == ¬±inf
s 11111111111 xx..x ‚ÇÇ ==  nan
```
]

---

## Not a Number

```lua
nan ~= nan -- true
```

--

```lua
nan = math.sqrt(-1)
nan = 0 / 0
```

--

```lua
nan > nan -- false
nan < nan -- false
nan == nan -- false
```

--

```lua
nan + 1 -- nan
nan * 2 -- nan
```

--

```lua
1 ^ nan -- 1
nan ^ 0 -- 1
```

---

## Not a Number


```console
$ man pow

SYNOPSIS
    #include <math.h>
    double pow(double x, double y);

RETURN VALUE

    If x is +1, the result is 1.0 (even if y is a NaN).
    If y is 0, the result is 1.0 (even if x is a NaN).
```

.footnote[
  [Linux man page](https://linux.die.net/man/3/pow)
]

???

–í—ã–≤–æ–¥ –∑–¥–µ—Å—å –Ω–µ —Ç–æ—Ç, –æ –∫–æ—Ç–æ—Ä–æ–º –≤—ã –º–æ–≥–ª–∏ –ø–æ–¥—É–º–∞—Ç—å. –í—ã–≤–æ–¥ - –∏–∑–±–µ–≥–∞–π—Ç–µ
–Ω–∞–Ω–æ–≤ –≤–æ–æ–±—â–µ. –ù–∞–Ω—ã –Ω–µ –¥–ª—è –±–∏–∑–Ω–µ—Å –ª–æ–≥–∏–∫–∏.

<!-- ############################################################ -->
---

## LuaJIT internal tags


```c
// lj_obj.h

// Interpreted as a double these are special NaNs. The FPU only generates
// one type of NaN (0xfff8_0000_0000_0000). So MSWs > 0xfff80000 are available
// for use as internal tags.
//                  ---MSW---.---LSW---
// primitive types |  itype  |         |
// lightuserdata   |  itype  |  void * |
// GC objects      |  itype  |  GCRef  |
// int (LJ_DUALNUM)|  itype  |   int   |
// number           -------double------

#define LJ_TNIL     (~0u)
#define LJ_TFALSE   (~1u)
#define LJ_TTRUE    (~2u)
#define LJ_TSTR     (~4u)
#define LJ_TTAB     (~11u)
```

???

–ù–æ –Ω–∞–Ω—ã –≤ —Å–∏—à–∫–µ –º–æ–≥—É—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω—ã–º–∏. –í –ª—É–∞–¥–∂–∏—Ç–µ –µ—Å—Ç—å –æ–¥–Ω–æ –∫–ª–∞—Å—Å–Ω–æ–µ
–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä—ã–º —è —Ö–æ—á—É —Å –≤–∞–º–∏ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è.

<!-- ############################################################ -->
---
## –¢–∞–±–ª–∏—Ü—ã

```lua
t1 = { 'Sunday', 'Monday', 'Im tired' }
```

???

–†–∞—Å—Å–∫–∞–∑–∞–ª. –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –ø—Ä–æ—Å—Ç–æ—Ç–µ —Ç–∏–ø–æ–≤ –∏ –æ–ø–∞—Å–Ω–æ—Å—Ç—è–º, –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω–∏ —Ç–∞—è—Ç.
–¢–∞–±–ª–∏—Ü–∞ - —ç—Ç–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
–¥–ª—è –≤—Å–µ–≥–æ –Ω–∞ —Å–≤–µ—Ç–µ. –ù—É –∞ –∫—É–¥–∞ –¥–µ–≤–∞—Ç—å—Å—è —Ç–æ, –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –Ω–µ—Ç—É.

--

```lua
t2 = {
    cat = 'meow',
    dog = 'woof',
    cow = 'moo',
}
```

--

```lua
t3 = {
    'k1', 'k2', 'k3',
    ['k1'] = 'v1',
    ['k2'] = 'v2',
    ['k3'] = 'v3',
}
```

<!-- ############################################################ -->
---

## –¢–∞–±–ª–∏—Ü—ã –∏–∑–Ω—É—Ç—Ä–∏

```c
typedef struct GCtab {
  /* GC stuff */
  MRef array;     /* Array part. */
  MRef node;      /* Hash part.  */
  uint32_t asize; /* Size of array part (keys [0, asize-1]). */
  uint32_t hmask; /* Hash part mask (size of hash part - 1). */
} GCtab;
```

???

–í –∫–æ–¥–µ –ª—É–∞–¥–∂–∏—Ç–∞ —Ç–∞–±–ª–∏—Ü—ã –≤—ã–≥–ª—è–¥—è—Ç —Ç–∞–∫

---

## –¢–∞–±–ª–∏—Ü—ã –∏–∑–Ω—É—Ç—Ä–∏

```c
typedef struct GCtab {
  /* GC stuff */
* MRef array;     /* Array part. */
  MRef node;      /* Hash part.  */
* uint32_t asize; /* Size of array part (keys [0, asize-1]). */
  uint32_t hmask; /* Hash part mask (size of hash part - 1). */
} GCtab;
```

???

–ï—Å—Ç—å —á–∞—Å—Ç—å —Å –º–∞—Å—Å–∏–≤–æ–º

---

## –¢–∞–±–ª–∏—Ü—ã –∏–∑–Ω—É—Ç—Ä–∏

```c
typedef struct GCtab {
  /* GC stuff */
  MRef array;     /* Array part. */
* MRef node;      /* Hash part.  */
  uint32_t asize; /* Size of array part (keys [0, asize-1]). */
* uint32_t hmask; /* Hash part mask (size of hash part - 1). */
} GCtab;
```

---

## –¢–∞–±–ª–∏—Ü—ã –∏–∑–Ω—É—Ç—Ä–∏

```lua
t = {}
-- table: 0x40eae3a8
--  a[0]:
--  h[1]: nil=nil
```

--

```lua
t["a"] = "A"
t["b"] = "B"
t["c"] = "C"
-- table: 0x40eae3a8
--  a[0]:
--  h[4]: b=B, nil=nil, a=A, c=C
```

---

## –¢–∞–±–ª–∏—Ü—ã –∏–∑–Ω—É—Ç—Ä–∏

```lua
t1 = {a = 1, b = 2, c = 3}
-- table: 0x40eaeb08
--  a[0]:
--  h[4]: b=2, nil=nil, a=1, c=3

t2 = {c = 3, b = 2, a = 1}
-- table: 0x40ea7e70
--  a[0]:
--  h[4]: b=2, nil=nil, c=3, a=1
```

--

```lua
traverse(pairs, t1)
-- b=2, a=1, c=3

traverse(pairs, t2)
-- b=2, c=3, a=1
```

---

## –¢–∞–±–ª–∏—Ü—ã –∏–∑–Ω—É—Ç—Ä–∏

```lua
t2["c"] = nil
-- table: 0x411c83c0
--  a[0]:
--  h[4]: b=2, nil=nil, c=nil, a=1
```

???

–î–∞–≤–∞–π—Ç–µ –¥–∞–ª—å—à–µ –ø–æ–ø—Ä–æ–±—É–µ–º —É–¥–∞–ª–∏—Ç—å –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –∑–Ω–∞—á–µ–Ω–∏–µ.
–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ –∫–ª—é—á –≤ —Ç–∞–±–ª–∏—Ü–µ –Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è.

--

```lua
next(t2, "c") -- a
next(t2, "d") -- error: invalid key to 'next'
```

???

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–µ —Ç–æ–ª—å–∫–æ –∏–∑–±–µ–∂–∞—Ç—å –ª–∏—à–Ω–∏—Ö —Ç–µ–ª–æ–¥–≤–∏–∂–µ–Ω–∏–π, –Ω–æ –∏ –Ω–µ –ª–æ–º–∞—Ç—å –ª—É–∫–∞–ø.
–ê –æ–Ω –Ω–∞–º –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã –≤ —Ü–∏–∫–ª–µ –º–æ–∂–Ω–æ –±—ã–ª–æ —É–¥–∞–ª—è—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã

--

```lua
for k, v in pairs(t) do
    t[k] = v .. '_new' -- –º–æ–∂–Ω–æ

    t[k .. '_new'] = nil -- –Ω–µ–ª—å–∑—è
end
```

---

## –ú–∞—Å—Å–∏–≤—ã

```lua
t = {1, 2}
-- table: 0x41735918
--  a[3]: nil, 1, 2
--  h[1]: nil=nil
```

???

–õ–∞–¥–Ω–æ, —Å –∏—Ç–µ—Ä–∞—Ü–∏–µ–π –ø–æ —Å—Ç—Ä–æ–∫–æ–≤—ã–º –∫–ª—é—á–∞–º –≤—Å—ë –ø–æ–Ω—è—Ç–Ω–æ, —Å –Ω–∏—Ö —Å–ø—Ä–æ—Å—É –Ω–µ—Ç.
–î–∞–≤–∞–π—Ç–µ —Ç–µ–ø–µ—Ä—å –ø–æ–≥–æ–≤–æ—Ä–∏–º –æ –≤—Ç–æ—Ä–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ —Ç–∞–±–ª–∏—Ü—ã ‚Äî –æ –º–∞—Å—Å–∏–≤–µ:
<br/><br/>
–ù–∞–¥ Lua —á–∞—Å—Ç–æ —à—É—Ç—è—Ç –∑–∞ —Ç–æ, —á—Ç–æ –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ —è–∑—ã–∫–µ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –µ–¥–∏–Ω–∏—Ü—ã.
–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ —Ç–æ, —á—Ç–æ LuaJIT –≤—Å—ë —Ä–∞–≤–Ω–æ –≤—ã–¥–µ–ª—è–µ—Ç –ø–∞–º—è—Ç—å –ø–æ–¥ –Ω—É–ª–µ–≤–æ–π —ç–ª–µ–º–µ–Ω—Ç.

--

```lua
t = {[2] = 2, 1}
-- table: 0x416a3998
--  a[2]: nil, 1
--  h[2]: nil=nil, 2=2
```

???

–ï—Å–ª–∏ –≤–∞–º –∫–∞–∂–µ—Ç—Å—è, —á—Ç–æ —Å –º–∞—Å—Å–∏–≤–∞–º–∏ –Ω–∏–∫–∞–∫–∏—Ö —Å—é—Ä–ø—Ä–∏–∑–æ–≤ –±—ã—Ç—å –Ω–µ –º–æ–∂–µ—Ç, —Ç–æ
—Å–ø–µ—à—É –≤–∞—Å –æ–≥–æ—Ä—á–∏—Ç—å (–∏–ª–∏ –æ–±—Ä–∞–¥–æ–≤–∞—Ç—å) ‚Äî –º–æ–∂–µ—Ç:
<br/><br/>
–Ø –Ω–µ–º–Ω–æ–≥–æ –∏–∑–º–µ–Ω–∏–ª —Å–∏–Ω—Ç–∞–∫—Å–∏—Å, –∏ –æ–¥–∏–Ω —ç–ª–µ–º–µ–Ω—Ç —ç–ª–µ–º–µ–Ω—Ç –ø–æ–ø–∞–ª –≤ –º–∞—Å—Å–∏–≤, –∞
–≤—Ç–æ—Ä–æ–π –≤ —Ö–µ—à-–º–∞–ø—É. –í –æ–±—â–µ–º, —è –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏–ª: –±–µ—Å–ø–æ–ª–µ–∑–Ω–æ –¥–µ–ª–∞—Ç—å
–ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏—è –æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–∏, –æ–Ω–∏ –±—É–¥—É—Ç –Ω–∞—Ä—É—à–µ–Ω—ã –≤ –ª—é–±–æ–π
–º–æ–º–µ–Ω—Ç.

--

```lua
t = table.new(4, 4)
for i = 1, 8 do t[i] = i end
-- table: 0x412c6df0
--  a[5]: nil, 1, 2, 3, 4
--  h[4]: 7=7, 8=8, 5=5, 6=6
```

???

–Ø –Ω–∏ –≤ –∫–æ–µ–º —Å–ª—É—á–∞–µ –Ω–µ —Ö–æ—á—É –ø–æ–∫–∞–∑–∞—Ç—å—Å—è –ø–∞—Ä–∞–Ω–æ–∏–∫–æ–º –∏ —Å–∞–º —Å—á–∏—Ç–∞—é —ç—Ç–æ—Ç
–ø—Ä–∏–º–µ—Ä –≤–µ—Å—å–º–∞ –Ω–µ–ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–Ω—ã–º. –í 99.9 % —Å–ª—É—á–∞–µ–≤ "–º–∞—Å—Å–∏–≤—ã" –≤ Lua
–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –±—É–¥—É—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –º–∞—Å—Å–∏–≤–∞–º–∏, –∏ –ø–æ—Ä—è–¥–æ–∫ –∏—Ç–µ—Ä–∞—Ü–∏–∏ –±—É–¥–µ—Ç
–ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω—ã–º.

<!-- ############################################################ -->
---

## –î–ª–∏–Ω–∞ –º–∞—Å—Å–∏–≤–∞ ‚Äî –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ

```lua
#{1, 2, 3} -- 3
```

.footnote[
  Lua 5.1 Reference Manual.
  [¬ß3.4.6 ‚Äì The Length Operator](https://www.lua.org/manual/5.1/manual.html#3.4.6)
]

???

–ò–Ω—ã–º–∏ —Å–ª–æ–≤–∞–º–∏, –Ω–µ –∫–∞–∂–¥–∞—è —Ç–∞–±–ª–∏—Ü–∞ –æ–±–ª–∞–¥–∞–µ—Ç —Å–≤–æ–π—Å—Ç–≤–æ–º –¥–ª–∏–Ω—ã. –°—é—Ä–ø—Ä–∏–∑ ‚Äî –≤
Lua –±—ã–≤–∞–µ—Ç undefined behavior. –£ —Ç–∞–±–ª–∏—Ü —Å "–¥—ã—Ä–∫–∞–º–∏" –ø–æ–ø—Ä–æ—Å—Ç—É –Ω–µ—Ç —Ç–∞–∫–æ–≥–æ
—Å–≤–æ–π—Å—Ç–≤–∞.

--

Undefined behavior:

```lua
*#{nil, 2} -- 2
-- table: 0x410d5528
--  a[3]: nil, nil, 2
--  h[1]: nil=nil

*#{[2] = 2} -- 0
-- table: 0x410d5810
--  a[0]:
--  h[2]: nil=nil, 2=2
```

???

–°–≤–æ–π—Å—Ç–≤–∞ –Ω–µ—Ç, –∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä –µ—Å—Ç—å. LuaJIT –∏—â–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ "–≥—Ä–∞–Ω–∏—Ü—É". –ï—Å–ª–∏ –≤
–º–∞—Å—Å–∏–≤–µ –µ—Å—Ç—å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, –∞ –∑–Ω–∞—á–∏—Ç –≥—Ä–∞–Ω–∏—Ü —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ,
—Ç–æ LuaJIT –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤ –º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ –ª—é–±—É—é –∏–∑ –Ω–∏—Ö, –∏
–±—É–¥–µ—Ç –ø—Ä–∞–≤:

<!-- ############################################################ -->
---

## –û—Ç–∫—É–¥–∞ –±–µ—Ä—É—Ç—Å—è –¥—ã—Ä–∫–∏?

```diff
- t[i] = nil
+ table.remove(t, i)
```

???

–û—Ç–∫—É–¥–∞ –±–µ—Ä—É—Ç—Å—è –¥—ã—Ä–∫–∏ –≤—Å–µ –∑–Ω–∞—é—Ç, ? –í–æ-–ø–µ—Ä–≤—ã—Ö, –∫—Ç–æ-—Ç–æ –∑–∞–±—ã–≤–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
table.remove –∏ –¥–µ–ª–∞–µ—Ç t[i] = nil

--

```lua
function vararg(...)
    local args = {...}
    -- #args == undefined behavior
end

vararg(nil, "err")
```

???
–í—Ç–æ—Ä–æ–π —Å–ø–æ—Å–æ–± - –∑–∞–≤–µ—Ä–Ω—É—Ç—å –≤–∞—Ä–∞—Ä–≥ –≤ —Ç–∞–±–ª–∏—Ü—É.

---

## –î–ª–∏–Ω–∞ –º–∞—Å—Å–∏–≤–∞ ‚Äî –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ

```lua
table.sort(t) -- 1, #t
unpack(t) -- 1, #t
```

???

–ü—Ä–æ–±–ª–µ–º—ã –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è, –∫–æ–≥–¥–∞ –º—ã —Å —Ç–∞–∫–æ–π —Ç–∞–±–ª–∏—Ü–µ–π –ø—ã—Ç–∞–µ–º—Å—è —Ä–∞–±–æ—Ç–∞—Ç—å.

–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ –æ—Ç 1 –¥–æ #t, –∏ –Ω–µ—Ç –Ω–∏–∫–∞–∫–æ–≥–æ
—Å–ø–æ—Å–æ–±–∞ –Ω–∞ —ç—Ç–æ –ø–æ–≤–ª–∏—è—Ç—å. –ü–æ—ç—Ç–æ–º—É –≤ —Ç–µ—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö, –∫–æ—Ç–æ—Ä—ã–µ —Ä–∞–±–æ—Ç–∞—é—Ç —Å
—Ç–∞–±–ª–∏—Ü–µ–π –∫–∞–∫ —Å –º–∞—Å—Å–∏–≤–æ–º, –ø–æ–ª–µ–∑–Ω–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤—Ö–æ–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:

--

```lua
function table.pack(...)
    return {n = select('#', ...), ...}
end

t = table.pack(nil, 2)
unpack(t, 1, t.n) -- nil, 2
```

???

–ï—â–µ —á–∞—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∞–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏—è unpack(t), —É –Ω–∞—Å –ø–æ –∫—Ä–∞–π–Ω–µ–π –º–µ—Ä–µ –¥–∞ –≤–æ –≤—Å—è–∫–∏—Ö –ø—Ä–æ–∫—Å—è—Ö.
–ü–æ –¥–µ—Ñ–æ–ª—Ç—É –æ–Ω–∞ —Ç–æ–∂–µ —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç #—Ç–æ —Ö–≤–æ—Å—Ç –º–æ–∂–µ—Ç –æ—Ç–≤–∞–ª–∏—Ç—å—Å—è (–∞ –º–æ–∂–µ—Ç –∏ –Ω–µ—Ç, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–µ–∑–µ–Ω–∏—è, —ç—Ç–æ –≤–µ–¥—å UB).

---

## –ò—Ç–µ—Ä–∞—Ü–∏–∏

```lua
for i = 1, #t do
end

for i, v in ipairs(t) do
end
```

--

```lua
-- ipairs:
local i = 1
while type(t[i]) ~= 'nil' do
    -- do something
    i = i + 1
end
```

<!-- ############################################################ -->
---

## FFI –∏ cdata

```lua
ffi = require('ffi')
NULL = ffi.new('void*', nil)

type(nil) -- nil
type(NULL) -- cdata
ffi.typeof(box.NULL) -- ctype<void *>
```

---

## FFI –∏ cdata

```lua
ffi = require('ffi')
NULL = ffi.new('void*', nil)

type(nil) -- nil
type(NULL) -- cdata
ffi.typeof(box.NULL) -- ctype<void *>

*NULL == nil -- true
```

---

## FFI –∏ cdata

```lua
ffi = require('ffi')
NULL = ffi.new('void*', nil)

type(nil) -- nil
type(NULL) -- cdata
ffi.typeof(box.NULL) -- ctype<void *>

NULL == nil -- true

*if NULL then
    print('NULL is not nil')
end
-- NULL is not nil
```

---

## FFI –∏ cdata

.center[![:scale 600px](images/nil-false-null.svg)]

???

–Ø —Ç—É—Ç –Ω–∞—Ä–∏—Å–æ–≤–∞–ª –∫–∞—Ä—Ç–∏–Ω–∫—É

<!-- ############################# -->
---
## –í—ã–≤–æ–¥—ã

- –°—Ç–∞—Ä–∞–π—Ç–µ—Å—å –ø–∏—Å–∞—Ç—å –∫–æ–¥ –±–µ–∑ –±–∞–≥–æ–≤ üòä
- –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –ø–æ–ª—å–∑—É–π—Ç–µ—Å—å –ª–∏–Ω—Ç–µ—Ä–∞–º–∏
- –ò–∑–±–µ–≥–∞–π—Ç–µ NaN
- –ù–µ –¥–µ–ª–∞–π—Ç–µ –ª–∏—à–Ω–∏—Ö –ø—Ä–µ–¥–ø–æ–ª–æ–∂–µ–Ω–∏–π
- –ë–æ–π—Ç–µ—Å—å –¥—ã—Ä—è–≤—ã—Ö –º–∞—Å—Å–∏–≤–æ–≤

???

–ß—Ç–æ –∂, –¥–∞–≤–∞–π—Ç–µ –ø–æ–¥–≤–µ–¥—ë–º –∏—Ç–æ–≥–∏.

<br/>
# –í–æ–ø—Ä–æ—Å—ã?
