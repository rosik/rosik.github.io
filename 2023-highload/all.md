class: titlepage
background-size: contain
background-image: url(template/bg-title-left.svg)

# Как при помощи бумаги, карандаша<br/> и алгоритма Raft достичь консенсуса
## Ярослав Дынников
### Picodata
.footnote[Слайды: https://rosik.github.io/2023-highload]
???
* Зачем мы здесь (пересказ тезисов)
* *Сформировать ожидания аудитории*
* Я провожу этот мастер-класс второй раз.
* Тема сложная, поэтому не стесняйтесь перебивать.

<!-- ############################################################ -->
<!-- ############################################################ -->
<!-- ############################################################ -->
---
# О чем речь
Кластер — это группа процессов, работающих совместно и
представляющихся пользователю единым компьютерным ресурсом.
???
* Анекдот про "что такое кластер". Опрос аудитории.
* Прояним. Кластер — это группа процессов, работающих совместно и
  представляющихся пользователю единым компьютерным ресурсом.
* Набор микросервисов — это кластер. Но интереснее стейтфул.

---
# О чем речь
Кластер — это группа процессов, работающих совместно и
представляющихся пользователю единым компьютерным ресурсом.
## Задача
* Есть несколько серверов.
* Надо достичь консенсуса.
???
Задача сводится к следующему:
- Есть несколько серверов.
- Мы хотим чтобы данные на них были консистентны.
- Бахнем двухфазный коммит и цель достигнута.

---
# О чем речь
Кластер — это группа процессов, работающих совместно и
представляющихся пользователю единым компьютерным ресурсом.
## Задача
* Есть несколько серверов.
* Надо достичь консенсуса.
* В ненадежной сети.
???
- Но!
- Сеть имеет свойство рваться.

---
# О чем речь
Кластер — это группа процессов, работающих совместно и
представляющихся пользователю единым компьютерным ресурсом.
## Задача
* Есть несколько серверов.
* Надо достичь консенсуса.
* В ненадежной сети.

## Решение — Raft
* In search of Understandable Consensus Algorithm.
* Diego Ongaro and John Ousterhout. Stanford University.
* https://raft.github.io
???
- Есть много разных решений, Raft - одно из них.
- Я не буду даже упоминать другие, а буду тупо пиарить рафт.
- Построен с упором на понятность, но мозгу придется потрудиться.

<!-- ############################################################ -->
<!-- ############################################################ -->
<!-- ############################################################ -->
---
class: sectionpage
count: false
background-size: contain
background-image: url(template/bg-section.svg)
# Raft
???
- Наверняка всем не терпится начать, но сначала сейчас будет лекция на

<!-- ############################################################ -->
---
# Реплицируемый конечный автомат
.center[![:scale 1050px](images/raft-1.svg)]
???
- Рафт в качестве решения предлагает...
- Строим терминологический фундамент.

<!-- ############################################################ -->
---
# Персистентное хранилище
.center[![:scale 1050px](images/multiframe-1.svg#frame1)]
<!-- See: https://css-tricks.com/svg-fragment-identifiers-work/ -->
???
- А теперь взгляните на ваши листки.
- Стейт машины нет, есть только журнал.
- Сюда мы будем писать послание, по одной букве в клеточку.
- Содержание потом придумаете сами.

<!-- ############################################################ -->
---
# Лидер, фолловер, кандидат
.center[![:scale 1050px](images/raft-states.svg)]
- *Leader* единственный пишет в журнал + пингует окружающих
- *Follower* пассивен, не отправляет никаких запросов
- *Candidate* проводит голосование
???
- Продолжаем знакомиться с терминологией
- *Проговариваем картинку*
- Но что если лидеров несколько, это мы обязательно посмотрим на
  практике, а пока продолжаем теорию

<!-- ############################################################ -->
---
# Термы
Терм — это отрезок времени неопределенной длины. Он начинается с
выборов, после которых единственный лидер управляет кластером.

.center[![:scale 1050px](images/raft-terms.svg)]
???
- Рафт делить время на отрезки, которые называет термами.
- Я немного переиначил определение.
- Выборы могут провалиться, и тогда лидера не будет. Этот случай мы сегодня затронем.
- На разных серверах смена термов происходит в разные моменты времени.

<!-- ############################################################ -->
<!-- ############################################################ -->
<!-- ############################################################ -->
---
class: sectionpage
count: false
background-size: contain
background-image: url(template/bg-section.svg)
# Выборы лидера
## Игра 1
???
- Пауза, вопросы?

<!-- ############################################################ -->
<!-- --- -->
<!-- # Выборы лидера -->
<!-- .center[![:scale 1050px](images/multiframe-1.svg#frame2)] -->

<!-- ############################################################ -->
---
# i1, начинайте выборы
.center[![:scale 1050px](images/multiframe-1.svg#frame3)]
.timer[⏱]
???
- Транспорт-агностик
- В рафте это называется RPC
- Это сетевые сообщения.
- Чур у соседа не списывать.

<!-- ############################################################ -->
---
# i2-i8: «Ок».
.center[![:scale 1050px](images/multiframe-1.svg#frame4)]
.timer[⏱]
???
- Голосовать можно 1 раз за терм
- Голосуем за первого встречного
- Сначала персистим, потом отвечаем на запрос

<!-- ############################################################ -->
---
# i1: «У-хуу!»
.center[![:scale 1050px](images/multiframe-1.svg#frame5)]

<!-- ############################################################ -->
<!-- ############################################################ -->
<!-- ############################################################ -->
---
class: sectionpage
count: false
background-size: contain
background-image: url(template/bg-section.svg)
# Репликация журнала
## Игра 2
???
- Пауза, вопросы?

<!-- ############################################################ -->
---
# i1, заполняйте raft-журнал
.center[![:scale 1050px](images/multiframe-2.svg#frame1)]
.timer[⏱]

<!-- ############################################################ -->
---
# i1: «Заперсистьте!»
.center[![:scale 1050px](images/multiframe-2.svg#frame3)]
.timer[⏱]

<!-- ############################################################ -->
---
# i2-i8: «Ок».
.center[![:scale 1050px](images/multiframe-2.svg#frame4)]
.timer[⏱]
???
- Сначала персистим, потом отвечаем на запрос

<!-- ############################################################ -->
---
# i1: «Отлично!»
.center[![:scale 1050px](images/multiframe-2.svg#frame5)]

<!-- ############################################################ -->
---
# Состояние записей
.center[![:scale 1050px](images/raft-log-1.svg)]

<!-- ############################################################ -->
---
# i1: «Реплицируйтесь!»
.timer[⏱]
.center[![:scale 1050px](images/multiframe-2.svg#frame6)]

<!-- ############################################################ -->
---
# i2, i3, сохраняйте записи
.timer[⏱]
.center[![:scale 1050px](images/multiframe-2.svg#frame7)]


<!-- ############################################################ -->
---
# i4, "потеряйте" сообщение
.center[![:scale 1050px](images/multiframe-2.svg#frame8)]
???
- Даже не обрабатывайте, пополам порвите

<!-- ############################################################ -->
<!-- ############################################################ -->
<!-- ############################################################ -->
---
class: sectionpage
count: false
background-size: contain
background-image: url(template/bg-section.svg)
# Терм без лидера
## Игра 3
???
- Пауза, вопросы?

<!-- ############################################################ -->
---
# i4 и i1, вы "оффлайн"
Переверните ваши листки
???
- *Почему так произошло?*
- i4 понятное дело упал, потому и сообщение потерял.
- i1 еще какое-то время поработал и тоже устал.

<!-- ############################################################ -->
---
# i8, начинайте выборы
.center[![:scale 1050px](images/multiframe-3.svg#frame1)]
.timer[⏱]

<!-- ############################################################ -->
---
# i2, i3: «Не-а».
.center[![:scale 1050px](images/multiframe-3.svg#frame2)]
.timer[⏱]
???
- i8 отдает сообщение i2
<!-- ############################################################ -->
---
# i8: «😥».
.center[![:scale 1050px](images/multiframe-3.svg#frame3)]
.timer[⏱]
???
- Чтобы такое происходило не слишком часто, raft рандомизирует таймаут в
  некотором диапазоне, в етцд `[t, 2t)`.

<!-- ############################################################ -->
<!-- ############################################################ -->
<!-- ############################################################ -->
---
class: sectionpage
count: false
background-size: contain
background-image: url(template/bg-section.svg)
# Перезапись журнала
## Игра 4
???
- Пауза, вопросы?

<!-- ############################################################ -->
---
# i1 все еще "оффлайн"

Потерпите, через 4 слайда вернетесь.

<!-- ############################################################ -->
---
# i4, начинайте выборы
.center[![:scale 1050px](images/multiframe-3.svg#frame4)]
.timer[⏱]
???
- Терм t2 пропускаем
- Зачем? — Ради экономии времени

<!-- ############################################################ -->
---
# Вжух, и i4 теперь лидер
.center[![:scale 1050px](images/multiframe-3.svg#frame5)]
.timer[⏱]

<!-- ############################################################ -->
---
# i4, заполняйте raft-журнал
.center[![:scale 1050px](images/multiframe-4.svg#frame1)]
.timer[⏱]
???
- Любопытно: i4 до сих пор не знает коммит

<!-- ############################################################ -->
---
# i5-i8, обработайте запрос
.center[![:scale 1050px](images/multiframe-4.svg#frame2)]
.timer[⏱]

<!-- ############################################################ -->
---
# i1, возвращайтесь онлайн
.center[![:scale 1050px](images/multiframe-4.svg#frame3)]
.timer[⏱]
???
- i8, передайте листочки i1

<!-- ############################################################ -->
---
# i4 получает ответ
.center[![:scale 1050px](images/multiframe-4.svg#frame4)]
.timer[⏱]
???
- Конец

<!-- ############################################################ -->
---
# Факультатив

- Динамическое изменение топологии.
- Pre-vote.
- Applied индекс может обгонять persisted.

<!-- ############################################################ -->
---
class: finalpage
background-size: contain
background-image: url(template/bg-final.svg)

# Материалы

Слайды:
https://rosik.github.io/2023-highload

Picodata:
https://picodata.io/,
[@picodataru](https://t.me/picodataru)

Raft:
https://raft.github.io/

.qr[
  **Обратная связь**:<br/><br/>
  ![:scale 100%](images/qr.gif)
  <a href="https://conf.ontico.ru/online/shl2023/details/4937163">
  https://conf.ontico.ru<br>
  /online/shl2023<br>
  /details/4937163
  </a><br/><br/>
]
