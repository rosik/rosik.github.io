<!-- ############################################################ -->
# Алгоритм Raft
.footnote[https://raft.github.io]
## Задача
* Есть несколько серверов.
* Надо достичь консенсуса.
???
Задача сводится к следующему:
- Есть несколько серверов.
- Мы хотим чтобы данные на них были консистентны.
- Бахнем двухфазный коммит и цель достигнута.
---

# Алгоритм Raft
.footnote[https://raft.github.io]
## Задача
* Есть несколько серверов.
* Надо достичь консенсуса.
* В ненадёжной сети.
???
- Но!
- Сеть имеет свойство рваться.
---

# Алгоритм Raft
.footnote[https://raft.github.io]
## Задача
* Есть несколько серверов.
* Надо достичь консенсуса.
* В ненадёжной сети.

## Решение
* Реплицируемый конечный автомат.
* Replicated state machine.
???
- Есть много разных решений, Raft - одно из них.
- Я не буду даже упоминать другие, а буду тупо пиарить рафт.
- Построен с упором на понятность, но мозгу придется потрудиться.

<!-- ############################################################ -->
---
class: sectionpage
background-size: contain
background-image: url(template/bg-section.svg)
# Raft

<!-- ############################################################ -->
---
# Реплицируемый конечный автомат
.center[![:scale 1050px](images/raft-1.svg)]
???
- Рафт в качестве решения предлагает...
- Строим терминологический фундамент.

<!-- ############################################################ -->
---
# Персистентное хранилище
.center[![:scale 1050px](images/multiframe-1.svg#frame1)]
???
- А теперь взгляните на ваши листки.
- Стейт машины нет, есть только журнал.
- Сюда мы будем писать послание, по одной букве в клеточку.
- Содержание потом придумаете сами.

<!-- ############################################################ -->
---
# Лидер, фолловер, кандидат
.center[![:scale 1050px](images/raft-states.svg)]
- *Leader* единственный пишет в журнал + пингует окружающих
- *Follower* пассивен, не отправляет никаких запросов
- *Candidate* проводит голосование
???
- Продолжаем знакомиться с терминологией

<!-- ############################################################ -->
---
# Термы
.center[![:scale 1050px](images/raft-terms.svg)]

<!-- ############################################################ -->
---
class: sectionpage
background-size: contain
background-image: url(template/bg-section.svg)
# Выборы лидера
## Игра 1

<!-- ############################################################ -->
---
# Выборы лидера
.center[![:scale 1050px](images/multiframe-1.svg#frame2)]
<!-- See: https://css-tricks.com/svg-fragment-identifiers-work/ -->
???
- Транспорт-агностик
- В рафте это называется RPC

<!-- ############################################################ -->
---
# Кандидат: «Голосуйте за меня!»
.center[![:scale 1050px](images/multiframe-1.svg#frame3)]

<!-- ############################################################ -->
---
# Фолловеры: «Ок».
.center[![:scale 1050px](images/multiframe-1.svg#frame4)]
???
- Голосовать можно 1 раз за терм
- Голосуем за первого встречного
- Сначала персистим, потом отвечаем на запрос

<!-- ############################################################ -->
---
# Кандидат: «У-хуу!»
.center[![:scale 1050px](images/multiframe-1.svg#frame5)]

<!-- ############################################################ -->
---
class: sectionpage
background-size: contain
background-image: url(template/bg-section.svg)
# Репликация журнала
## Игра 2

<!-- ############################################################ -->
---
# Лидер заполняет raft-журнал
.center[![:scale 1050px](images/multiframe-2.svg#frame1)]

<!-- ############################################################ -->
---
# Лидер: «Заперсистьте!»
.center[![:scale 1050px](images/multiframe-2.svg#frame3)]

<!-- ############################################################ -->
---
# Фолловеры: «Ок».
.center[![:scale 1050px](images/multiframe-2.svg#frame4)]
???
- Сначала персистим, потом отвечаем на запрос

<!-- ############################################################ -->
---
# Лидер: «Отлично!»
.center[![:scale 1050px](images/multiframe-2.svg#frame5)]

<!-- ############################################################ -->
---
# Состояние записей
.center[![:scale 1050px](images/raft-log-1.svg)]

<!-- ############################################################ -->
---
# Лидер: «Реплицируйтесь!»
.center[![:scale 1050px](images/multiframe-2.svg#frame6)]

<!-- ############################################################ -->
---
# Фолловеры: «Ок».
.center[![:scale 1050px](images/multiframe-2.svg#frame7)]

<!-- ############################################################ -->
---
class: sectionpage
background-size: contain
background-image: url(template/bg-section.svg)
# Split vote
## Игра 3

<!-- ############################################################ -->
---
# Кандидаты: «Голосуйте за меня!»

.center[![:scale 1050px](images/multiframe-3.svg#frame1)]
???
- i1, переверните листки, вы offline
- i4, i8 начинайте выборы

<!-- ############################################################ -->
---
# Фолловеры: «Не-а».
.center[![:scale 1050px](images/multiframe-3.svg#frame2)]

<!-- ############################################################ -->
---
# Материалы

- Слайды: https://rosik.github.io/2022-fit-m

- Picodata: [@picodataru](https://t.me/picodataru), https://picodata.io/

- Raft: https://raft.github.io/

> In search of Understandable Consensus Algorithm.<br/>
  Diego Ongaro and John Ousterhout.<br/>
  Stanford University.
