<!-- ############################################################ -->
# Алгоритм Raft
.footnote[https://raft.github.io]

## Задача

* Достичь консенсуса
--
* В ненадёжной сети
--

## Решение

* Реплицируемый конечный автомат<br> Replicated state machine

???

- Задача сводится к следующему: есть несколько серверов. Мы хотим чтобы
  данные на них были консистентны, и чтобы система была отказоустойчива.

- Есть много разных решений, Raft - одно из них. Я не хочу вам читать
  лекцию про все их семейство, а сфокусируюсь только на Raft'е.

- Построен с упором на понятность

- Поднимите руки кто с этой задачей знаком.


<!-- ############################################################ -->
---

# Реплицируемый конечный автомат

.center[![:scale 1050px](images/raft-1.svg)]

<!-- ############################################################ -->
---

# Реквизит

.center[![:scale 1050px](images/s1.svg)]

<!-- ############################################################ -->
---
# Правила
.center[![:scale 1050px](images/raft-2.svg)]

---
# Правила
Follower:
- Пассивен
- Не отправляет никаких запросов

Leader:
- Обслуживает запросы
- Добавляет записи в журнал
- Пингует окружающих

Candidate:
- Проводит голосование

---
# Правила

.center[![:scale 1050px](images/raft-3.svg)]

---
## Все получают raft_id
.center[![:scale 1050px](images/game-1-3.svg)]
???
- *Все участники*, проведите жеребьевку и заполните raft_id

---
## Все пропускают первые выборы
<!-- vote term -->
.center[![:scale 1050px](images/game-1-4.svg)]

???
- В оригинальной статье описание алгоритма начинается с выборов лидера,
  но мы с вами пойдем другим путем. Что такое термы я вам позже
  расскажу, а на первом раунде давайте не отлекаться
- Мы упростим задачу и ограничимся журналом
- *Все участники*, проголосуйте в первом терме за raft_id 1.
- Надеюсь очевидно, что если журнал у всех одинаковый, то машина состояний тоже будет консистентной

---
## Лидер заполняет журнал
.center[![:scale 1050px](images/game-1-5.svg)]
???
- Тезис: Добавлять записи в рафт журнал имеет право только лидер
- Raft не защищает от византийских атак, поэтому просьба следовать протоколу.
- *Лидеры*, заполните журнал.

---
## AppendEntries RPC
<!-- Лидер отправляет запрос AppendEntries -->
.center[![:scale 1050px](images/game-1-6.svg)]
???
- Оговориться про топологию сети.
- *Лидеры*, заполните AppendEntries.

---
## AppendEntries RPC
<!-- Фолловеры обрабатывают запрос AppendEntries -->
.center[![:scale 1050px](images/game-1-7.svg)]

---
## AppendEntries RPC
<!-- Лидер получает ответ на AppendEntries -->
.center[![:scale 1050px](images/game-1-8.svg)]

---
## AppendEntries RPC
<!-- Лидер отправляет второй AppendEntries -->
.center[![:scale 1050px](images/game-1-9.svg)]

???

- Тут приходит злой лаг и теряет пакет
- *Raft_id 6*, дропните пожалуйста этот пакет, не обраатывайте и больше никому не давайте.
- А в другом кластере raft_id 5.

<!-- ############################################################ -->
---
## Replicated state machine
.center[![:scale 1050px](images/raft-1.svg)]
???
- Прежде чем идти дальше, подведем промежуточный итог.
- Вы отреплицировали 4 записи, вы молодцы.
- Но некоторые подробности остались за бортом - стейт машина. Что
  интересно, рафт не навязывает никакого физического смысла по поводу
  содержимого.

---
## Эволюция записей в журнале
.center[![:scale 1050px](images/raft-log-1.svg)]

???

- Вы посмотрели на процесс глазами сервера, давайе теперь проговорим
  судьбу каждой записи в журнале ее глазами.

---
## Эволюция записей в журнале
.center[![:scale 1050px](images/raft-log-2.svg)]


<!-- ############################################################ -->

---
## Кто-то начинает новый терм
.center[![:scale 1050px](images/game-2-1.svg)]

---
## RequestVote RPC
<!-- Кандидат отправляет RequestVote -->
.center[![:scale 1050px](images/game-2-2.svg)]

---
## RequestVote RPC
<!-- Все обрабатывают RequestVote -->
.center[![:scale 1050px](images/game-2-3.svg)]

---
## Состояния серверов
.center[![:scale 1050px](images/raft-2.svg)]

???
- И опять сделаем паузу, я вам расскажу какие вообще статусы бывают.
  Их всего три.

<!-- ############################################################ -->
---
## Term 2
.center[![:scale 1050px](images/game-3-1.svg)]

---
## Откат журнала
.center[![:scale 1050px](images/game-3-2.svg)]

???
- Мораль: незакоммиченные записи теряются.

<!-- ############################################################ -->
---
## Изменение топологии
.center[![:scale 1050px](images/cc-1.svg)]

---
## Изменение топологии
.center[![:scale 1050px](images/cc-2.svg)]

---
## Изменение топологии
.center[![:scale 1050px](images/cc-3.svg)]

---
## Joint consensus
.center[![:scale 1050px](images/cc-joint.svg)]

---
## Joint consensus
.center[![:scale 1050px](images/cc-4.svg)]

---
## Joint consensus
.center[![:scale 1050px](images/raft-cc.svg)]

---
## Joint consensus
.center[![:scale 1050px](images/cc-5.svg)]


<!-- ############################################################ -->
---
## Материалы

- Слайды: https://rosik.github.io/2022-fit-m

- Picodata: [@picodataru](https://t.me/picodataru), https://picodata.io/

- Raft: https://raft.github.io/

> In search of Understandable Consensus Algorithm.<br/>
  Diego Ongaro and John Ousterhout.<br/>
  Stanford University.
